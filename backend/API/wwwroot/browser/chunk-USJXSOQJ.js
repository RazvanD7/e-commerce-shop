import{L as g,Ua as n,_a as f,f as u,k as m,pb as B,w as b,z as l}from"./chunk-UDTUQTR4.js";var i=[];for(let r=0;r<256;++r)i.push((r+256).toString(16).slice(1));function x(r,t=0){return(i[r[t+0]]+i[r[t+1]]+i[r[t+2]]+i[r[t+3]]+"-"+i[r[t+4]]+i[r[t+5]]+"-"+i[r[t+6]]+i[r[t+7]]+"-"+i[r[t+8]]+i[r[t+9]]+"-"+i[r[t+10]]+i[r[t+11]]+i[r[t+12]]+i[r[t+13]]+i[r[t+14]]+i[r[t+15]]).toLowerCase()}var d,y=new Uint8Array(16);function c(){if(!d){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");d=crypto.getRandomValues.bind(crypto)}return d(y)}var U=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),I={randomUUID:U};function S(r,t,e){if(I.randomUUID&&!t&&!r)return I.randomUUID();r=r||{};let s=r.random??r.rng?.()??c();if(s.length<16)throw new Error("Random bytes length must be >= 16");if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,t){if(e=e||0,e<0||e+16>t.length)throw new RangeError(`UUID byte range ${e}:${e+15} is out of buffer bounds`);for(let a=0;a<16;++a)t[e+a]=s[a];return t}return x(s)}var k=S;var o=class{id=k();items=[]};var v=class r{constructor(t,e){this.http=t;this.platformId=e}baseUrl=B.apiUrl;basketSource=new u(new o);basket$=this.basketSource.asObservable();basketTotalSource=new u({shipping:0,total:0,subtotal:0});basketTotal$=this.basketTotalSource.asObservable();shipping=0;createPaymentIntent(){return this.http.post(this.baseUrl+"payments/"+this.getCurrentBasketValue().id,{}).pipe(m(t=>{this.basketSource.next(t)}))}setShippingPrice(t){this.shipping=t.price;let e=this.getCurrentBasketValue();e.deliveryMethodId=t.id,e.shippingPrice=t.price,this.calculateTotal(),this.setBasket(e)}getBasket(t){return this.http.get(this.baseUrl+"basket?id="+t).pipe(m(e=>{this.basketSource.next(e),this.shipping=e.shippingPrice??0,this.calculateTotal()}))}setBasket(t){return this.http.post(this.baseUrl+"basket",t).subscribe(e=>{this.basketSource.next(e),this.calculateTotal()},e=>{console.log(e)})}getCurrentBasketValue(){return this.basketSource.value}addItemToBasket(t,e=1){let s=this.mapProductItemToBasketItem(t,e),a=this.getCurrentBasketValue();n(this.platformId)&&!localStorage.getItem("basket_id")?a=this.createBasket():a||(a=this.createBasket()),a.items=this.addOrUpdateItem(a.items,s,e),this.setBasket(a)}addOrUpdateItem(t,e,s){let a=t.findIndex(p=>p.id===e.id);return a===-1?(e.quantity=s,t.push(e)):t[a].quantity+=s,t}incrementItemQuantity(t){let e=this.getCurrentBasketValue(),s=e.items.findIndex(a=>a.id===t.id);e.items[s].quantity++,this.setBasket(e)}decrementItemQuantity(t){let e=this.getCurrentBasketValue(),s=e.items.findIndex(a=>a.id===t.id);e.items[s].quantity>1?(e.items[s].quantity--,this.setBasket(e)):this.removeItemFromBasket(t)}removeItemFromBasket(t){let e=this.getCurrentBasketValue();e.items.some(s=>s.id===t.id)&&(e.items=e.items.filter(s=>s.id!==t.id),e.items.length>0?this.setBasket(e):this.deleteBasket(e))}deleteBasket(t){return this.http.delete(this.baseUrl+"basket?id="+t.id).subscribe(()=>{this.basketSource.next(new o),this.basketTotalSource.next({shipping:0,total:0,subtotal:0}),n(this.platformId)&&localStorage.removeItem("basket_id")},e=>{console.log(e)})}calculateTotal(){let t=this.getCurrentBasketValue(),e=this.shipping,s=t.items.reduce((p,h)=>h.price*h.quantity+p,0),a=s+e;this.basketTotalSource.next({shipping:e,total:a,subtotal:s})}createBasket(){let t=new o;return n(this.platformId)&&localStorage.setItem("basket_id",t.id),this.setBasket(t),t}mapProductItemToBasketItem(t,e){return{id:t.id,productName:t.name,price:t.price,pictureUrl:t.pictureUrl,quantity:e,band:t.productBand,type:t.productType}}deleteLocalBasket(){this.basketSource.next(new o),this.basketTotalSource.next({shipping:0,total:0,subtotal:0}),localStorage.removeItem("basket_id")}static \u0275fac=function(e){return new(e||r)(l(f),l(g))};static \u0275prov=b({token:r,factory:r.\u0275fac,providedIn:"root"})};export{v as a};
